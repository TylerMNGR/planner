<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Planner - Cloud Sync</title>
    <style>
        :root { --primary-bg: #1a365d; --accent-orange: #ff8c00; --card-white: #ffffff; --text-dark: #1e293b; --border: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--primary-bg); color: var(--text-dark); margin: 0; padding: 20px; }
        .top-branding { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; color: white; margin-bottom: 20px; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-area img { height: 50px; border-radius: 4px; }
        .main-title { text-align: center; font-size: 2.2rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        .live-clock { text-align: right; font-weight: bold; font-size: 1rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card-white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .nav-bar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; color: white; }
        .controls { display: flex; gap: 10px; align-items: center; }
        #search-box { padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 200px; }
        button, .orange-btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 13px; background: var(--accent-orange); color: white; transition: transform 0.1s; display: inline-block; }
        .btn-nav { background: rgba(255,255,255,0.2); border: 1px solid white; min-width: 100px; }
        #task-form-container, #bulk-modal { background: var(--card-white); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 4px solid var(--accent-orange); display: none; }
        #bulk-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1100; width: 600px; box-shadow: 0 0 60px rgba(0,0,0,0.6); }
        .calendar-grid { display: grid; gap: 10px; }
        .grid-7 { grid-template-columns: repeat(7, 1fr); }
        .day-card { background: var(--card-white); border: 1px solid var(--border); border-radius: 8px; padding: 10px; min-height: 160px; }
        .day-label { font-weight: bold; color: #475569; font-size: 0.9rem; border-bottom: 2px solid #f1f5f9; margin-bottom: 10px; padding-bottom: 5px; display: block; }
        .day-card.today { border: 3px solid var(--accent-orange); background: #fffbeb; }
        .weekend { background: #f8fafc; }
        .task-item { position: relative; font-size: 0.85rem; background: #fff7ed; color: #9a3412; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 5px solid var(--accent-orange); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .assigned-tag { font-size: 0.7rem; font-weight: bold; color: #1e40af; background: #dbeafe; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; text-transform: uppercase; }
        .task-content { cursor: pointer; font-weight: 600; display: block; line-height: 1.4; }
        .delete-btn { position: absolute; top: 5px; right: 8px; color: #dc2626; font-weight: bold; cursor: pointer; font-size: 18px; }
        .view-dates-link { font-size: 11px; color: var(--primary-bg); font-weight: bold; cursor: pointer; margin-top: 8px; display: block; border-top: 1px solid #ffedd5; padding-top: 4px; }
        #occurrences-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 60px rgba(0,0,0,0.6); z-index: 1000; display: none; width: 380px; }
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.75); display: none; z-index: 999; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        label { font-weight: bold; font-size: 0.85rem; color: #475569; display: block; margin-bottom: 5px; }
        .sync-indicator { font-size: 0.7rem; color: #4ade80; margin-left: 10px; }
        .banner-box { padding: 15px; border-radius: 12px; margin-bottom: 10px; display: none; border: 2px solid #ef4444; background: #fee2e2; }
        .banner-tag { color: #b91c1c; font-weight: bold; }
        .gtt-btn { background: #1e40af; color: #facc15; padding: 12px 20px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px; border: 2px solid #facc15; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="top-branding">
    <div class="logo-area">
        <img src="https://www.blucomputers.co.uk/gallery_gen/cd6f202757dcc4e33c805062d83679ca_fit.png?ts=1766441461" alt="Logo">
        <span>Powered By Blu Computers <span id="sync-status" class="sync-indicator">‚óè Cloud Synced</span></span>
    </div>
    <div class="main-title">Workshop Planner</div>
    <div class="live-clock" id="clock">...</div>
</div>

<div class="container">
    <div id="announcement-bar" class="banner-box">
        <span class="banner-tag">ANNOUNCEMENT:</span> 
        <span id="display-message" style="color: #1e293b; margin-left: 10px; font-weight: 500;"></span>
    </div>
    <div id="vor-bar" class="banner-box" style="margin-bottom: 20px;">
        <span class="banner-tag">VOR:</span> 
        <span id="display-vor" style="color: #1e293b; margin-left: 10px; font-weight: 500;"></span>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <a href="https://tylermngr.github.io/GTT/" target="_blank" class="gtt-btn">OPEN GTT PORTAL</a>
        <div style="display: flex; gap: 10px;">
            <button onclick="updateGlobalMessage('announcement')" style="background: #475569; font-size: 11px; padding: 5px 10px;">Edit Announcement</button>
            <button onclick="updateGlobalMessage('vor')" style="background: #b91c1c; font-size: 11px; padding: 5px 10px;">Edit VOR Status</button>
        </div>
    </div>

    <header>
        <div class="controls">
            <h2 id="current-view-title" style="margin:0; color: var(--primary-bg); font-size: 1.2rem;">Planner</h2>
            <input type="text" id="search-box" placeholder="Search..." oninput="handleSearch()">
        </div>
        <div class="controls">
            <button onclick="changeView('week')">Weekly</button>
            <button onclick="changeView('month')">Monthly</button>
            <button onclick="checkPin(openBulkModal)" style="background: #475569;">Bulk Upload</button>
            <button onclick="loadFromCloud()" style="background: #64748b;">Sync Now</button>
        </div>
    </header>

    <div class="nav-bar">
        <button class="btn-nav" onclick="navigate(-1)">‚óÑ Previous</button>
        <button class="btn-nav" onclick="goToday()">Today</button>
        <button class="btn-nav" onclick="navigate(1)">Next ‚ñ∫</button>
        <span id="view-label" style="font-weight: bold; font-size: 1.2rem; min-width: 200px; text-align: center;"></span>
    </div>

    <button style="margin-bottom:20px; width:100%; font-size: 1.1rem; padding: 15px;" onclick="checkPin(openForm)">+ CREATE NEW WORKSHOP ENTRY (PIN REQUIRED)</button>

    <div id="task-form-container">
        <h3 id="form-title" style="margin-top:0;">New Job</h3>
        <input type="hidden" id="edit-id">
        <div class="form-row">
            <div><label>Date:</label><input type="date" id="task-date"></div>
            <div>
                <label>Assignee:</label>
                <select id="task-assignee">
                    <option value="Unassigned" selected>Unassigned</option>
                    <option value="Barry Baxter">Barry Baxter</option>
                    <option value="Jamie Hurry">Jamie Hurry</option>
                    <option value="KMS">KMS</option>
                    <option value="Workshop Manager">Workshop Manager</option>
                    <option value="AVR">AVR</option>
                    <option value="RB Trucks">RB Trucks</option>
                </select>
            </div>
            <div>
                <label>Repeat:</label>
                <select id="task-repeat">
                    <option value="none">One Time</option>
                    <option value="5w">5 Weeks</option>
                    <option value="10w">10 Weeks</option>
                    <option value="6m">6 Months</option>
                    <option value="12m">12 Months</option>
                </select>
            </div>
        </div>
        <textarea id="task-desc" rows="3" placeholder="Description..."></textarea>
        <div style="margin-top:15px; display: flex; gap: 10px;">
            <button id="save-btn" onclick="saveTask()" style="flex: 2;">Save to Cloud</button>
            <button onclick="closeForm()" style="flex: 1; background:#e2e8f0; color:#475569;">Cancel</button>
        </div>
    </div>

    <div id="bulk-modal">
        <h3>Bulk Upload</h3>
        <textarea id="bulk-input" rows="10" placeholder="YYYY-MM-DD, Assignee, Desc, Repeat"></textarea>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="processBulk()" style="flex:2;">Process</button>
            <button onclick="closeBulkModal()" style="flex:1; background:#e2e8f0; color:#475569;">Cancel</button>
        </div>
    </div>

    <div id="calendar-display" class="calendar-grid"></div>
</div>

<div id="modal-overlay" onclick="closeAllModals()"></div>
<div id="occurrences-modal">
    <h3 style="margin-top:0;">Recurring Dates</h3>
    <ul id="occurrence-list" style="margin-bottom: 25px;"></ul>
    <button onclick="closeModal()" style="width:100%;">Close</button>
</div>

<script>
    const FIREBASE_URL = 'https://workshopplanner-c2dfe-default-rtdb.firebaseio.com/tasks.json';
    const MESSAGE_URL = 'https://workshopplanner-c2dfe-default-rtdb.firebaseio.com/message.json';
    const VOR_URL = 'https://workshopplanner-c2dfe-default-rtdb.firebaseio.com/vor.json';
    const REQUIRED_PIN = "0007";
    const MSG_PIN = "1984";
    
    let currentView = 'week';
    let currentDate = new Date();
    let tasks = [];

    async function loadBanners() {
        try {
            const resMsg = await fetch(MESSAGE_URL);
            const dataMsg = await resMsg.json();
            const barMsg = document.getElementById('announcement-bar');
            if (dataMsg && dataMsg.text && dataMsg.text.trim() !== "") {
                document.getElementById('display-message').innerText = dataMsg.text;
                barMsg.style.display = 'block';
            } else { barMsg.style.display = 'none'; }
            const resVor = await fetch(VOR_URL);
            const dataVor = await resVor.json();
            const barVor = document.getElementById('vor-bar');
            if (dataVor && dataVor.text && dataVor.text.trim() !== "") {
                document.getElementById('display-vor').innerText = dataVor.text;
                barVor.style.display = 'block';
            } else { barVor.style.display = 'none'; }
        } catch (e) { console.error("Banner sync failed"); }
    }

    async function updateGlobalMessage(type) {
        const pin = prompt("Enter PIN ():");
        if (pin !== MSG_PIN) return alert("Invalid PIN.");
        const promptText = type === 'vor' ? "Enter VOR Status:" : "Enter Announcement:";
        const url = type === 'vor' ? VOR_URL : MESSAGE_URL;
        const newValue = prompt(promptText);
        if (newValue === null) return;
        try {
            await fetch(url, { method: 'PUT', body: JSON.stringify({ text: newValue }) });
            loadBanners();
        } catch (e) { alert("Save failed."); }
    }

    async function loadFromCloud() {
        loadBanners();
        const status = document.getElementById('sync-status');
        status.innerText = "‚óè Syncing...";
        status.style.color = "#fbbf24";
        try {
            const response = await fetch(FIREBASE_URL);
            const data = await response.json();
            tasks = data ? Object.values(data) : [];
            render();
            status.innerText = "‚óè Cloud Synced";
            status.style.color = "#4ade80";
        } catch (e) {
            status.innerText = "‚óè Sync Error";
            status.style.color = "#ef4444";
        }
    }

    async function saveToCloud() {
        try {
            await fetch(FIREBASE_URL, { method: 'PUT', body: JSON.stringify(tasks) });
            loadFromCloud();
        } catch (e) { alert("Save failed."); }
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleDateString('en-GB', { 
            weekday: 'short', day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
    }
    setInterval(updateClock, 1000); updateClock();

    function navigate(direction) {
        if (currentView === 'week') currentDate.setDate(currentDate.getDate() + (direction * 7));
        else currentDate.setMonth(currentDate.getMonth() + direction);
        render();
    }

    function goToday() { currentDate = new Date(); render(); }

    function handleSearch() {
        const query = document.getElementById('search-box').value.toLowerCase();
        if (query.trim() !== "") {
            // Find the earliest matching task across all occurrences
            let earliestMatch = null;
            tasks.forEach(task => {
                if (task.desc.toLowerCase().includes(query) || (task.assignee && task.assignee.toLowerCase().includes(query))) {
                    const instances = getRecurrences(task, 50); // Scan forward 50 instances
                    instances.forEach(inst => {
                        if (!earliestMatch || inst < earliestMatch) {
                            earliestMatch = inst;
                        }
                    });
                }
            });
            if (earliestMatch) {
                currentDate = new Date(earliestMatch);
            }
        }
        render();
    }

    function checkPin(callback, arg = null) {
        const pin = prompt("Enter PIN:");
        if (pin === REQUIRED_PIN) callback(arg);
        else if (pin !== null) alert("Invalid PIN.");
    }

    function openForm(editId = null) {
        document.getElementById('task-form-container').style.display = 'block';
        if (editId) {
            const t = tasks.find(x => x.id === editId);
            document.getElementById('edit-id').value = t.id;
            document.getElementById('task-date').value = t.date;
            document.getElementById('task-assignee').value = t.assignee || 'Unassigned';
            document.getElementById('task-repeat').value = t.repeat;
            document.getElementById('task-desc').value = t.desc;
        } else { resetForm(); }
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('task-date').value = '';
        document.getElementById('task-assignee').value = 'Unassigned';
        document.getElementById('task-repeat').value = 'none';
        document.getElementById('task-desc').value = '';
    }

    function closeForm() { document.getElementById('task-form-container').style.display = 'none'; }
    function openBulkModal() { document.getElementById('modal-overlay').style.display = 'block'; document.getElementById('bulk-modal').style.display = 'block'; }
    function closeBulkModal() { document.getElementById('bulk-modal').style.display = 'none'; document.getElementById('modal-overlay').style.display = 'none'; }
    function closeAllModals() { closeBulkModal(); closeModal(); }

    function processBulk() {
        const lines = document.getElementById('bulk-input').value.split('\n');
        lines.forEach(line => {
            const p = line.split(',').map(x => x.trim());
            if (p.length >= 3 && !isNaN(Date.parse(p[0]))) {
                tasks.push({ id: "id-" + Date.now() + Math.random().toString(36).substr(2, 5), date: p[0], assignee: p[1], desc: p[2], repeat: p[3] || 'none' });
            }
        });
        saveToCloud(); closeBulkModal();
    }

    function saveTask() {
        const editId = document.getElementById('edit-id').value;
        const date = document.getElementById('task-date').value;
        const assignee = document.getElementById('task-assignee').value;
        const repeat = document.getElementById('task-repeat').value;
        const desc = document.getElementById('task-desc').value;
        if (!date || !desc) return alert("Required fields missing.");
        if (editId) tasks = tasks.filter(t => t.id !== editId);
        tasks.push({ id: editId || "id-" + Date.now(), date, assignee, repeat, desc });
        saveToCloud();
        closeForm();
    }

    function deleteTask(id, e) {
        e.stopPropagation();
        checkPin(() => {
            if(confirm("Delete?")) {
                tasks = tasks.filter(t => t.id !== id);
                saveToCloud();
            }
        });
    }

    function getRecurrences(task, limit = 20) {
        let results = [];
        let start = new Date(task.date);
        start.setHours(0,0,0,0);
        results.push(new Date(start));
        if (task.repeat === 'none') return results;
        let current = new Date(start);
        for (let i = 0; i < limit; i++) {
            let nextDate = new Date(current);
            if (task.repeat === '5w') nextDate.setDate(current.getDate() + 35);
            else if (task.repeat === '10w') nextDate.setDate(current.getDate() + 70);
            else if (task.repeat === '6m') nextDate.setMonth(current.getMonth() + 6);
            else if (task.repeat === '12m') nextDate.setMonth(current.getMonth() + 12);
            while (nextDate.getDay() === 0 || nextDate.getDay() === 6) {
                nextDate.setDate(nextDate.getDate() + 1);
            }
            results.push(new Date(nextDate));
            current = new Date(nextDate);
        }
        return results;
    }

    function isTaskOnDate(task, checkDate) {
        const check = new Date(checkDate);
        check.setHours(0,0,0,0);
        const instances = getRecurrences(task);
        return instances.some(inst => inst.getTime() === check.getTime());
    }

    function render() {
        const display = document.getElementById('calendar-display');
        const query = document.getElementById('search-box').value.toLowerCase();
        const label = document.getElementById('view-label');
        display.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);
        display.className = "calendar-grid grid-7";

        if (currentView === 'week') {
            let startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - (currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1));
            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            label.innerText = `${startOfWeek.toLocaleDateString('en-GB', {day:'numeric', month:'short'})} - ${endOfWeek.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'})}`;
            for (let i = 0; i < 7; i++) {
                let d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i);
                renderDay(display, d, query, d.getTime() === today.getTime());
            }
        } else {
            label.innerText = currentDate.toLocaleDateString('en-GB', {month: 'long', year: 'numeric'});
            let last = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            for (let i = 1; i <= last; i++) {
                let d = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                renderDay(display, d, query, d.getTime() === today.getTime());
            }
        }
    }

    function renderDay(container, date, query, isToday) {
        const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
        const dayTasks = tasks.filter(t => isTaskOnDate(t, date) && (t.desc.toLowerCase().includes(query) || (t.assignee && t.assignee.toLowerCase().includes(query))));
        const taskHtml = dayTasks.map(t => `
            <div class="task-item">
                <span class="delete-btn" onclick="deleteTask('${t.id}', event)">√ó</span>
                <span class="assigned-tag">${t.assignee}</span>
                <span class="task-content" onclick="checkPin(openForm, '${t.id}')">${t.desc}</span>
                ${t.repeat !== 'none' ? `<span class="view-dates-link" onclick="showOccurrences('${t.id}', event)">üìÖ Recurring</span>` : ''}
            </div>`).join('');
        container.innerHTML += `
            <div class="day-card ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}">
                <span class="day-label">${date.toLocaleDateString('en-GB', {weekday:'short', day:'numeric'})}</span>
                ${taskHtml}
            </div>`;
    }

    function showOccurrences(id, e) {
        e.stopPropagation();
        const task = tasks.find(t => t.id === id);
        const list = document.getElementById('occurrence-list');
        list.innerHTML = '';
        const instances = getRecurrences(task);
        instances.forEach(inst => {
            const li = document.createElement('li');
            li.innerText = inst.toLocaleDateString('en-GB', {dateStyle: 'full'});
            list.appendChild(li);
        });
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('occurrences-modal').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('occurrences-modal').style.display = 'none'; }
    function changeView(v) { currentView = v; render(); }
    
    loadFromCloud();
    setInterval(loadFromCloud, 30000); 
</script>
</body>
</html>
